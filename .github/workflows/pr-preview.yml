name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-deploy-preview:
    name: Build and deploy preview to gh-pages/previews
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Verify npm version and upgrade if needed
        run: |
          node --version
          npm --version || true
          echo "Ensuring npm >= 10.8.3"
          npm install -g npm@10.8.3
          npm --version
      - name: Install dependencies (tolerant)
        run: npm install --no-audit --no-fund --prefer-offline

      - name: Build project
        run: npm run build

      - name: Add preview README into build
        run: |
          mkdir -p dist/public
          cat > dist/public/PREVIEW_README.md <<'EOF'
          NDI_MardiGrasParade - Preview Build
          This archive contains the built preview for this PR. To run locally:
          1) Extract the files and serve the directory with a static server.
             Example (Node):
               npm install -g http-server
               http-server -p 5000
               open http://localhost:5000
          2) Or use Python:
               python -m http.server 5000
               open http://localhost:5000
          NOTE: This preview was generated by a GitHub Actions run. If a public preview was published it will be available at:
             https://<owner>.github.io/<repo>/previews/<run_id>/
          EOF
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-dist-${{ github.run_id }}
          path: ./dist/public

      - name: Deploy to gh-pages (previews/<run_id>)
        if: ${{ secrets.GH_PAGES_PAT != '' || secrets.GH_PAGES_DEPLOY_TOKEN != '' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          # Accept either GH_PAGES_PAT (original) or GH_PAGES_DEPLOY_TOKEN (new name) as the deploy token
          github_token: ${{ secrets.GH_PAGES_PAT || secrets.GH_PAGES_DEPLOY_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./dist/public
          # Place builds under previews/<run_id> so multiple previews can coexist
          destination_dir: previews/${{ github.run_id }}

      - name: Comment PR with artifact and run link
        uses: actions/github-script@v6
        with:
          # Use a Personal Access Token stored in repo secrets so this action can post comments from PRs/forks.
          github-token: ${{ secrets.GH_ACTIONS_BOT_PAT }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const runId = process.env.GITHUB_RUN_ID;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            const artifactName = `preview-dist-${runId}`;
            const ghPagesUrl = `https://${owner}.github.io/${repo}/previews/${runId}/`;
            const bodyLines = [
              `âœ… Preview build uploaded as artifact: **${artifactName}**`,
              `\nDownload it from the Actions run page (open the link and click 'Artifacts'):`,
              runUrl,
              `\n`,
              `If a public preview was published to GitHub Pages it will (or will soon) be available at:`,
              ghPagesUrl,
              `\nIf you don't see the preview or the gh-pages URL isn't live, ensure a repository secret named \`GH_PAGES_PAT\` or \`GH_PAGES_DEPLOY_TOKEN\` is set (PAT with repo push permission) or download the artifact manually.`
            ];
            const body = bodyLines.join('\n');
            await github.rest.issues.createComment({ owner, repo, issue_number: context.payload.pull_request.number, body });
